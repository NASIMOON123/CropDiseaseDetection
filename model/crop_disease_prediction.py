# -*- coding: utf-8 -*-
"""crop_disease_prediction.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1th8OUK0jytgQLU5v-4USOjB_HhY0wotQ
"""

from google.colab import drive
drive.mount('/content/drive')

!ls /content/drive/

!ls /content/drive/MyDrive/

!cp -r "/content/drive/MyDrive/plantvillage/color" "/content/color"

!ls /content/color

from tensorflow.keras.preprocessing.image import ImageDataGenerator
from tensorflow.keras.applications import MobileNetV2
from tensorflow.keras.models import Model
from tensorflow.keras.layers import Dense, GlobalAveragePooling2D, Dropout
from tensorflow.keras.optimizers import Adam
from tensorflow.keras.callbacks import ModelCheckpoint
import os

dataset_dir = "/content/color"
print(os.listdir(dataset_dir))  # should list all class folders

train_datagen = ImageDataGenerator(
    rescale=1./255,
    rotation_range=20,
    width_shift_range=0.2,
    height_shift_range=0.2,
    shear_range=0.2,
    zoom_range=0.2,
    horizontal_flip=True,
    fill_mode='nearest',
    validation_split=0.2
)

train_generator = train_datagen.flow_from_directory(
    dataset_dir,
    target_size=(224,224),
    batch_size=32,
    class_mode='categorical',
    subset='training',
    shuffle=True
)

validation_generator = train_datagen.flow_from_directory(
    dataset_dir,
    target_size=(224,224),
    batch_size=32,
    class_mode='categorical',
    subset='validation',
    shuffle=True
)

base_model = MobileNetV2(weights='imagenet', include_top=False, input_shape=(224,224,3))

x = base_model.output
x = GlobalAveragePooling2D()(x)
x = Dense(1024, activation='relu')(x)
x = Dropout(0.5)(x)
predictions = Dense(train_generator.num_classes, activation='softmax')(x)

model = Model(inputs=base_model.input, outputs=predictions)

for layer in base_model.layers:
    layer.trainable = False

model.compile(optimizer=Adam(learning_rate=0.001), loss='categorical_crossentropy', metrics=['accuracy'])
model.summary()

checkpoint = ModelCheckpoint(
    '/content/drive/MyDrive/final_crop_disease_model_v2.h5',
    monitor='val_accuracy',
    save_best_only=True,
    mode='max',
    verbose=1
)

# ✅ Step 8: Train the Model
history = model.fit(
    train_generator,
    validation_data=validation_generator,
    epochs=10,                  # You can change this number (e.g., 5, 10, 15)
    callbacks=[checkpoint]      # Saves the best model automatically
)

from keras.models import load_model

# Load the best saved model from Drive
model = load_model('/content/drive/MyDrive/final_crop_disease_model_v2.h5')

!ls -lh /content/drive/MyDrive | grep .h5

model.save('/content/drive/MyDrive/final_crop_disease_model_v2_final.h5')

import numpy as np
import matplotlib.pyplot as plt
from tensorflow.keras.preprocessing import image
from keras.models import load_model
import json
from google.colab import files
from PIL import Image

# ✅ Load your trained model
model = load_model('/content/drive/MyDrive/final_crop_disease_model_v2_final.h5')

# ✅ Class indices (auto from your training generator if available)
# You can get this from: print(train_generator.class_indices)
# Example (change based on your dataset):
class_labels = {
    0: "Apple___Apple_scab",
    1: "Apple___Black_rot",
    2: "Apple___Cedar_apple_rust",
    3: "Apple___healthy",
    4: "Corn___Cercospora_leaf_spot",
    5: "Corn___Common_rust",
    6: "Corn___healthy",
    7: "Potato___Early_blight",
    8: "Potato___Late_blight",
    9: "Potato___healthy"
}

# ✅ Disease descriptions
disease_info = {
    "Apple___Apple_scab": "A fungal disease causing dark, scabby lesions on leaves and fruit.",
    "Apple___Black_rot": "Caused by Botryosphaeria obtusa; leads to leaf spots and fruit decay.",
    "Apple___Cedar_apple_rust": "Orange spots on leaves; occurs when apple trees are near junipers.",
    "Apple___healthy": "This apple leaf is healthy with no signs of disease.",
    "Corn___Cercospora_leaf_spot": "Spots on leaves; caused by Cercospora fungus, reduces yield.",
    "Corn___Common_rust": "Red or brown pustules on leaves; caused by Puccinia sorghi fungus.",
    "Corn___healthy": "This corn leaf is healthy with no visible infections.",
    "Potato___Early_blight": "Dark spots with concentric rings; caused by Alternaria solani fungus.",
    "Potato___Late_blight": "Water-soaked spots; caused by Phytophthora infestans, affects tubers too.",
    "Potato___healthy": "This potato leaf looks healthy and green."
}

# ✅ Upload image
uploaded = files.upload()

for fn in uploaded.keys():
    # Load and preprocess image
    path = fn
    img = Image.open(path).resize((224, 224))
    img_array = image.img_to_array(img)
    img_array = np.expand_dims(img_array, axis=0) / 255.0

    # Predict
    predictions = model.predict(img_array)
    predicted_class = np.argmax(predictions)
    class_name = class_labels[predicted_class]

    # ✅ Display image and result
    plt.imshow(img)
    plt.axis('off')
    plt.title(f"Prediction: {class_name}")
    plt.show()

    # ✅ Print detailed info
    print(f"Predicted Class: {class_name}")
    print(f"Description: {disease_info.get(class_name, 'No description available.')}")

print(model.output_shape)

from tensorflow.keras.preprocessing.image import ImageDataGenerator

train_dir = "/content/color"  # <-- your training folder

datagen = ImageDataGenerator(rescale=1./255)
train_gen = datagen.flow_from_directory(
    train_dir,
    target_size=(224, 224),
    batch_size=32,
    class_mode='categorical'
)

# ✅ Automatically get mapping
class_labels = {v: k for k, v in train_gen.class_indices.items()}
print(class_labels)

model.save('/content/drive/MyDrive/final_crop_disease_model_v2_final.h5')

